import { EventEmitter, Input, Output, Directive } from '@angular/core';
import { convertToBoolean } from '../../utils/util';
import * as i0 from "@angular/core";
const poTreeViewMaxLevel = 4;
/**
 * @description
 *
 * O componente fornece um modelo de visualização em árvore, possibilitando a visualização das informações de maneira
 * hierárquica, desta forma sendo possível utilizar até 4 níveis.
 *
 * Nele é possível navegar entre os itens através da tecla *tab*, permitindo expandir ou colapsar o item em foco
 * por meio das teclas *enter* e *space*.
 *
 * Além da navegação, o componente possibilita também a seleção dos itens do primeiro ao último nível, tanto de forma parcial como completa.
 *
 * O componente também possui eventos disparados ao marcar/desmarcar e expandir/colapsar os itens.
 */
export class PoTreeViewBaseComponent {
    constructor() {
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao colapsar um item.
         *
         * > Como parâmetro o componente envia o item colapsado.
         */
        this.collapsed = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao expandir um item.
         *
         * > Como parâmetro o componente envia o item expandido.
         */
        this.expanded = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao selecionar um item.
         *
         * > Como parâmetro o componente envia o item selecionado.
         */
        this.selected = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao desfazer a seleção de um item.
         *
         * > Como parâmetro o componente envia o item que foi desmarcado.
         */
        this.unselected = new EventEmitter();
        this._items = [];
        this._selectable = false;
    }
    /**
     * Lista de itens do tipo `PoTreeViewItem` que será renderizada pelo componente.
     */
    set items(value) {
        this._items = Array.isArray(value) ? this.getItemsByMaxLevel(value) : [];
    }
    get items() {
        return this._items;
    }
    /**
     * @optional
     *
     * @description
     *
     * Habilita uma caixa de seleção para selecionar e/ou desmarcar um item da lista.
     *
     * @default false
     */
    set selectable(value) {
        this._selectable = convertToBoolean(value);
    }
    get selectable() {
        return this._selectable;
    }
    emitExpanded(treeViewItem) {
        const event = treeViewItem.expanded ? 'expanded' : 'collapsed';
        this[event].emit({ ...treeViewItem });
    }
    emitSelected(treeViewItem) {
        const event = treeViewItem.selected ? 'selected' : 'unselected';
        this.updateItemsOnSelect(treeViewItem);
        this[event].emit({ ...treeViewItem });
    }
    addChildItemInParent(childItem, parentItem) {
        if (!parentItem.subItems) {
            parentItem.subItems = [];
        }
        parentItem.subItems.push(childItem);
    }
    // caso houver parentItem:
    //  - expande o parentItem caso o filho estiver expandido;
    //  - adiciona o childItem no parentItem;
    //  - marca o parentItem caso conter subItems marcodos ou nulos;
    // Se não conter parentItem, adiciona o childItem no items.
    addItem(items, childItem, parentItem, isNewItem) {
        if (parentItem) {
            if (isNewItem) {
                this.expandParentItem(childItem, parentItem);
            }
            this.addChildItemInParent(childItem, parentItem);
            this.selectItemBySubItems(parentItem);
            items.push(parentItem);
        }
        else {
            items.push(childItem);
        }
    }
    selectAllItems(items, isSelected) {
        items.forEach(item => {
            if (item.subItems) {
                this.selectAllItems(item.subItems, isSelected);
            }
            item.selected = isSelected;
        });
    }
    selectItemBySubItems(item) {
        item.selected = this.everyItemSelected(item.subItems);
    }
    // retornará:
    //  - true: se todos os items estiverem marcados;
    //  - null: se no minimo um item esteja marcado ou nullo (indeterminate)
    //  - false: caso não corresponda em nenhuma das opções acima, no caso, nenhum marcado ou nulo;
    everyItemSelected(items = []) {
        const itemsLength = items.length;
        const lengthCheckedItems = items.filter(item => item.selected).length;
        if (itemsLength && itemsLength === lengthCheckedItems) {
            return true;
        }
        const hasIndeterminateItems = items.filter(item => item.selected || item.selected === null).length;
        if (hasIndeterminateItems) {
            return null;
        }
        return false;
    }
    // expande o item pai caso o filho estiver expandido.
    expandParentItem(childItem, parentItem) {
        if (childItem.expanded) {
            parentItem.expanded = true;
        }
    }
    getItemsByMaxLevel(items = [], level = 0, parentItem, newItems = []) {
        items.forEach(item => {
            const { subItems, ...currentItem } = item;
            if (level === poTreeViewMaxLevel) {
                return;
            }
            if (Array.isArray(subItems)) {
                // caso um item pai iniciar selecionado, deve selecionar os filhos.
                if (currentItem.selected) {
                    this.selectAllItems(subItems, currentItem.selected);
                }
                this.getItemsByMaxLevel(subItems, ++level, currentItem);
                --level;
            }
            this.addItem(newItems, currentItem, parentItem, true);
        });
        return newItems;
    }
    getItemsWithParentSelected(items = [], parentItem, newItems = []) {
        items.forEach(item => {
            const { subItems, ...currentItem } = item;
            if (Array.isArray(subItems)) {
                this.getItemsWithParentSelected(subItems, currentItem);
            }
            this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    }
    updateItemsOnSelect(selectedItem) {
        if (selectedItem.subItems) {
            this.selectAllItems(selectedItem.subItems, selectedItem.selected);
        }
        this._items = this.getItemsWithParentSelected(this.items);
    }
}
PoTreeViewBaseComponent.ɵfac = function PoTreeViewBaseComponent_Factory(t) { return new (t || PoTreeViewBaseComponent)(); };
PoTreeViewBaseComponent.ɵdir = /*@__PURE__*/ i0.ɵɵdefineDirective({ type: PoTreeViewBaseComponent, inputs: { items: ["p-items", "items"], selectable: ["p-selectable", "selectable"] }, outputs: { collapsed: "p-collapsed", expanded: "p-expanded", selected: "p-selected", unselected: "p-unselected" } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(PoTreeViewBaseComponent, [{
        type: Directive
    }], null, { collapsed: [{
            type: Output,
            args: ['p-collapsed']
        }], expanded: [{
            type: Output,
            args: ['p-expanded']
        }], selected: [{
            type: Output,
            args: ['p-selected']
        }], unselected: [{
            type: Output,
            args: ['p-unselected']
        }], items: [{
            type: Input,
            args: ['p-items']
        }], selectable: [{
            type: Input,
            args: ['p-selectable']
        }] }); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdHJlZS12aWV3LWJhc2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLXRyZWUtdmlldy9wby10cmVlLXZpZXctYmFzZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV2RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQzs7QUFJcEQsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFFN0I7Ozs7Ozs7Ozs7OztHQVlHO0FBRUgsTUFBTSxPQUFPLHVCQUF1QjtJQURwQztRQUVFOzs7Ozs7OztXQVFHO1FBQ29CLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUV0RTs7Ozs7Ozs7V0FRRztRQUNtQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQWtCLENBQUM7UUFFcEU7Ozs7Ozs7O1dBUUc7UUFDbUIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO1FBRXBFOzs7Ozs7OztXQVFHO1FBQ3FCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUVoRSxXQUFNLEdBQTBCLEVBQUUsQ0FBQztRQUNuQyxnQkFBVyxHQUFZLEtBQUssQ0FBQztLQW9LdEM7SUFsS0M7O09BRUc7SUFDSCxJQUFzQixLQUFLLENBQUMsS0FBNEI7UUFDdEQsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMzRSxDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFD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b250ZW50IjpbImltcG9ydCB7IEV2ZW50RW1pdHRlciwgSW5wdXQsIE91dHB1dCwgRGlyZWN0aXZlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGNvbnZlcnRUb0Jvb2xlYW4gfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcblxuaW1wb3J0IHsgUG9UcmVlVmlld0l0ZW0gfSBmcm9tICcuL3BvLXRyZWUtdmlldy1pdGVtL3BvLXRyZWUtdmlldy1pdGVtLmludGVyZmFjZSc7XG5cbmNvbnN0IHBvVHJlZVZpZXdNYXhMZXZlbCA9IDQ7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTyBjb21wb25lbnRlIGZvcm5lY2UgdW0gbW9kZWxvIGRlIHZpc3VhbGl6YcOnw6NvIGVtIMOhcnZvcmUsIHBvc3NpYmlsaXRhbmRvIGEgdmlzdWFsaXphw6fDo28gZGFzIGluZm9ybWHDp8O1ZXMgZGUgbWFuZWlyYVxuICogaGllcsOhcnF1aWNhLCBkZXN0YSBmb3JtYSBzZW5kbyBwb3Nzw612ZWwgdXRpbGl6YXIgYXTDqSA0IG7DrXZlaXMuXG4gKlxuICogTmVsZSDDqSBwb3Nzw612ZWwgbmF2ZWdhciBlbnRyZSBvcyBpdGVucyBhdHJhdsOpcyBkYSB0ZWNsYSAqdGFiKiwgcGVybWl0aW5kbyBleHBhbmRpciBvdSBjb2xhcHNhciBvIGl0ZW0gZW0gZm9jb1xuICogcG9yIG1laW8gZGFzIHRlY2xhcyAqZW50ZXIqIGUgKnNwYWNlKi5cbiAqXG4gKiBBbMOpbSBkYSBuYXZlZ2HDp8OjbywgbyBjb21wb25lbnRlIHBvc3NpYmlsaXRhIHRhbWLDqW0gYSBzZWxlw6fDo28gZG9zIGl0ZW5zIGRvIHByaW1laXJvIGFvIMO6bHRpbW8gbsOtdmVsLCB0YW50byBkZSBmb3JtYSBwYXJjaWFsIGNvbW8gY29tcGxldGEuXG4gKlxuICogTyBjb21wb25lbnRlIHRhbWLDqW0gcG9zc3VpIGV2ZW50b3MgZGlzcGFyYWRvcyBhbyBtYXJjYXIvZGVzbWFyY2FyIGUgZXhwYW5kaXIvY29sYXBzYXIgb3MgaXRlbnMuXG4gKi9cbkBEaXJlY3RpdmUoKVxuZXhwb3J0IGNsYXNzIFBvVHJlZVZpZXdCYXNlQ29tcG9uZW50IHtcbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogQcOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgYW8gY29sYXBzYXIgdW0gaXRlbS5cbiAgICpcbiAgICogPiBDb21vIHBhcsOibWV0cm8gbyBjb21wb25lbnRlIGVudmlhIG8gaXRlbSBjb2xhcHNhZG8uXG4gICAqL1xuICBAT3V0cHV0KCdwLWNvbGxhcHNlZCcpIGNvbGxhcHNlZCA9IG5ldyBFdmVudEVtaXR0ZXI8UG9UcmVlVmlld0l0ZW0+KCk7XG5cbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogQcOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgYW8gZXhwYW5kaXIgdW0gaXRlbS5cbiAgICpcbiAgICogPiBDb21vIHBhcsOibWV0cm8gbyBjb21wb25lbnRlIGVudmlhIG8gaXRlbSBleHBhbmRpZG8uXG4gICAqL1xuICBAT3V0cHV0KCdwLWV4cGFuZGVkJykgZXhwYW5kZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFBvVHJlZVZpZXdJdGVtPigpO1xuXG4gIC8qKlxuICAgKiBAb3B0aW9uYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uXG4gICAqXG4gICAqIEHDp8OjbyBxdWUgc2Vyw6EgZGlzcGFyYWRhIGFvIHNlbGVjaW9uYXIgdW0gaXRlbS5cbiAgICpcbiAgICogPiBDb21vIHBhcsOibWV0cm8gbyBjb21wb25lbnRlIGVudmlhIG8gaXRlbSBzZWxlY2lvbmFkby5cbiAgICovXG4gIEBPdXRwdXQoJ3Atc2VsZWN0ZWQnKSBzZWxlY3RlZCA9IG5ldyBFdmVudEVtaXR0ZXI8UG9UcmVlVmlld0l0ZW0+KCk7XG5cbiAgLyoqXG4gICAqIEBvcHRpb25hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICpcbiAgICogQcOnw6NvIHF1ZSBzZXLDoSBkaXNwYXJhZGEgYW8gZGVzZmF6ZXIgYSBzZWxlw6fDo28gZGUgdW0gaXRlbS5cbiAgICpcbiAgICogPiBDb21vIHBhcsOibWV0cm8gbyBjb21wb25lbnRlIGVudmlhIG8gaXRlbSBxdWUgZm9pIGRlc21hcmNhZG8uXG4gICAqL1xuICBAT3V0cHV0KCdwLXVuc2VsZWN0ZWQnKSB1bnNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcblxuICBwcml2YXRlIF9pdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW107XG4gIHByaXZhdGUgX3NlbGVjdGFibGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogTGlzdGEgZGUgaXRlbnMgZG8gdGlwbyBgUG9UcmVlVmlld0l0ZW1gIHF1ZSBzZXLDoSByZW5kZXJpemFkYSBwZWxvIGNvbXBvbmVudGUuXG4gICAqL1xuICBASW5wdXQoJ3AtaXRlbXMnKSBzZXQgaXRlbXModmFsdWU6IEFycmF5PFBvVHJlZVZpZXdJdGVtPikge1xuICAgIHRoaXMuX2l0ZW1zID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB0aGlzLmdldEl0ZW1zQnlNYXhMZXZlbCh2YWx1ZSkgOiBbXTtcbiAgfVxuXG4gIGdldCBpdGVtcygpIHtcbiAgICByZXR1cm4gdGhpcy5faXRlbXM7XG4gIH1cblxuICAvKipcbiAgICogQG9wdGlvbmFsXG4gICAqXG4gICAqIEBkZXNjcmlwdGlvblxuICAgKlxuICAgKiBIYWJpbGl0YSB1bWEgY2FpeGEgZGUgc2VsZcOnw6NvIHBhcmEgc2VsZWNpb25hciBlL291IGRlc21hcmNhciB1bSBpdGVtIGRhIGxpc3RhLlxuICAgKlxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgQElucHV0KCdwLXNlbGVjdGFibGUnKSBzZXQgc2VsZWN0YWJsZSh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX3NlbGVjdGFibGUgPSBjb252ZXJ0VG9Cb29sZWFuKHZhbHVlKTtcbiAgfVxuXG4gIGdldCBzZWxlY3RhYmxlKCkge1xuICAgIHJldHVybiB0aGlzLl9zZWxlY3RhYmxlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRFeHBhbmRlZCh0cmVlVmlld0l0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XG4gICAgY29uc3QgZXZlbnQgPSB0cmVlVmlld0l0ZW0uZXhwYW5kZWQgPyAnZXhwYW5kZWQnIDogJ2NvbGxhcHNlZCc7XG5cbiAgICB0aGlzW2V2ZW50XS5lbWl0KHsgLi4udHJlZVZpZXdJdGVtIH0pO1xuICB9XG5cbiAgcHJvdGVjdGVkIGVtaXRTZWxlY3RlZCh0cmVlVmlld0l0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XG4gICAgY29uc3QgZXZlbnQgPSB0cmVlVmlld0l0ZW0uc2VsZWN0ZWQgPyAnc2VsZWN0ZWQnIDogJ3Vuc2VsZWN0ZWQnO1xuXG4gICAgdGhpcy51cGRhdGVJdGVtc09uU2VsZWN0KHRyZWVWaWV3SXRlbSk7XG5cbiAgICB0aGlzW2V2ZW50XS5lbWl0KHsgLi4udHJlZVZpZXdJdGVtIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRDaGlsZEl0ZW1JblBhcmVudChjaGlsZEl0ZW06IFBvVHJlZVZpZXdJdGVtLCBwYXJlbnRJdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGlmICghcGFyZW50SXRlbS5zdWJJdGVtcykge1xuICAgICAgcGFyZW50SXRlbS5zdWJJdGVtcyA9IFtdO1xuICAgIH1cblxuICAgIHBhcmVudEl0ZW0uc3ViSXRlbXMucHVzaChjaGlsZEl0ZW0pO1xuICB9XG5cbiAgLy8gY2FzbyBob3V2ZXIgcGFyZW50SXRlbTpcbiAgLy8gIC0gZXhwYW5kZSBvIHBhcmVudEl0ZW0gY2FzbyBvIGZpbGhvIGVzdGl2ZXIgZXhwYW5kaWRvO1xuICAvLyAgLSBhZGljaW9uYSBvIGNoaWxkSXRlbSBubyBwYXJlbnRJdGVtO1xuICAvLyAgLSBtYXJjYSBvIHBhcmVudEl0ZW0gY2FzbyBjb250ZXIgc3ViSXRlbXMgbWFyY29kb3Mgb3UgbnVsb3M7XG4gIC8vIFNlIG7Do28gY29udGVyIHBhcmVudEl0ZW0sIGFkaWNpb25hIG8gY2hpbGRJdGVtIG5vIGl0ZW1zLlxuICBwcml2YXRlIGFkZEl0ZW0oaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiwgY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtLCBpc05ld0l0ZW0/KSB7XG4gICAgaWYgKHBhcmVudEl0ZW0pIHtcbiAgICAgIGlmIChpc05ld0l0ZW0pIHtcbiAgICAgICAgdGhpcy5leHBhbmRQYXJlbnRJdGVtKGNoaWxkSXRlbSwgcGFyZW50SXRlbSk7XG4gICAgICB9XG4gICAgICB0aGlzLmFkZENoaWxkSXRlbUluUGFyZW50KGNoaWxkSXRlbSwgcGFyZW50SXRlbSk7XG4gICAgICB0aGlzLnNlbGVjdEl0ZW1CeVN1Ykl0ZW1zKHBhcmVudEl0ZW0pO1xuXG4gICAgICBpdGVtcy5wdXNoKHBhcmVudEl0ZW0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBpdGVtcy5wdXNoKGNoaWxkSXRlbSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RBbGxJdGVtcyhpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+LCBpc1NlbGVjdGVkOiBib29sZWFuKSB7XG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGlmIChpdGVtLnN1Ykl0ZW1zKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoaXRlbS5zdWJJdGVtcywgaXNTZWxlY3RlZCk7XG4gICAgICB9XG5cbiAgICAgIGl0ZW0uc2VsZWN0ZWQgPSBpc1NlbGVjdGVkO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3RJdGVtQnlTdWJJdGVtcyhpdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGl0ZW0uc2VsZWN0ZWQgPSB0aGlzLmV2ZXJ5SXRlbVNlbGVjdGVkKGl0ZW0uc3ViSXRlbXMpO1xuICB9XG5cbiAgLy8gcmV0b3JuYXLDoTpcbiAgLy8gIC0gdHJ1ZTogc2UgdG9kb3Mgb3MgaXRlbXMgZXN0aXZlcmVtIG1hcmNhZG9zO1xuICAvLyAgLSBudWxsOiBzZSBubyBtaW5pbW8gdW0gaXRlbSBlc3RlamEgbWFyY2FkbyBvdSBudWxsbyAoaW5kZXRlcm1pbmF0ZSlcbiAgLy8gIC0gZmFsc2U6IGNhc28gbsOjbyBjb3JyZXNwb25kYSBlbSBuZW5odW1hIGRhcyBvcMOnw7VlcyBhY2ltYSwgbm8gY2FzbywgbmVuaHVtIG1hcmNhZG8gb3UgbnVsbztcbiAgcHJpdmF0ZSBldmVyeUl0ZW1TZWxlY3RlZChpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW10pOiBib29sZWFuIHwgbnVsbCB7XG4gICAgY29uc3QgaXRlbXNMZW5ndGggPSBpdGVtcy5sZW5ndGg7XG5cbiAgICBjb25zdCBsZW5ndGhDaGVja2VkSXRlbXMgPSBpdGVtcy5maWx0ZXIoaXRlbSA9PiBpdGVtLnNlbGVjdGVkKS5sZW5ndGg7XG5cbiAgICBpZiAoaXRlbXNMZW5ndGggJiYgaXRlbXNMZW5ndGggPT09IGxlbmd0aENoZWNrZWRJdGVtcykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgaGFzSW5kZXRlcm1pbmF0ZUl0ZW1zID0gaXRlbXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5zZWxlY3RlZCB8fCBpdGVtLnNlbGVjdGVkID09PSBudWxsKS5sZW5ndGg7XG5cbiAgICBpZiAoaGFzSW5kZXRlcm1pbmF0ZUl0ZW1zKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvLyBleHBhbmRlIG8gaXRlbSBwYWkgY2FzbyBvIGZpbGhvIGVzdGl2ZXIgZXhwYW5kaWRvLlxuICBwcml2YXRlIGV4cGFuZFBhcmVudEl0ZW0oY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcbiAgICBpZiAoY2hpbGRJdGVtLmV4cGFuZGVkKSB7XG4gICAgICBwYXJlbnRJdGVtLmV4cGFuZGVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEl0ZW1zQnlNYXhMZXZlbChcbiAgICBpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW10sXG4gICAgbGV2ZWw6IG51bWJlciA9IDAsXG4gICAgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtLFxuICAgIG5ld0l0ZW1zID0gW11cbiAgKSB7XG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGNvbnN0IHsgc3ViSXRlbXMsIC4uLmN1cnJlbnRJdGVtIH0gPSBpdGVtO1xuXG4gICAgICBpZiAobGV2ZWwgPT09IHBvVHJlZVZpZXdNYXhMZXZlbCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KHN1Ykl0ZW1zKSkge1xuICAgICAgICAvLyBjYXNvIHVtIGl0ZW0gcGFpIGluaWNpYXIgc2VsZWNpb25hZG8sIGRldmUgc2VsZWNpb25hciBvcyBmaWxob3MuXG4gICAgICAgIGlmIChjdXJyZW50SXRlbS5zZWxlY3RlZCkge1xuICAgICAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoc3ViSXRlbXMsIGN1cnJlbnRJdGVtLnNlbGVjdGVkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZ2V0SXRlbXNCeU1heExldmVsKHN1Ykl0ZW1zLCArK2xldmVsLCBjdXJyZW50SXRlbSk7XG4gICAgICAgIC0tbGV2ZWw7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuYWRkSXRlbShuZXdJdGVtcywgY3VycmVudEl0ZW0sIHBhcmVudEl0ZW0sIHRydWUpO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIG5ld0l0ZW1zO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZChpdGVtczogQXJyYXk8UG9UcmVlVmlld0l0ZW0+ID0gW10sIHBhcmVudEl0ZW0/OiBQb1RyZWVWaWV3SXRlbSwgbmV3SXRlbXMgPSBbXSkge1xuICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICBjb25zdCB7IHN1Ykl0ZW1zLCAuLi5jdXJyZW50SXRlbSB9ID0gaXRlbTtcblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3ViSXRlbXMpKSB7XG4gICAgICAgIHRoaXMuZ2V0SXRlbXNXaXRoUGFyZW50U2VsZWN0ZWQoc3ViSXRlbXMsIGN1cnJlbnRJdGVtKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5hZGRJdGVtKG5ld0l0ZW1zLCBjdXJyZW50SXRlbSwgcGFyZW50SXRlbSk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3SXRlbXM7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUl0ZW1zT25TZWxlY3Qoc2VsZWN0ZWRJdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xuICAgIGlmIChzZWxlY3RlZEl0ZW0uc3ViSXRlbXMpIHtcbiAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoc2VsZWN0ZWRJdGVtLnN1Ykl0ZW1zLCBzZWxlY3RlZEl0ZW0uc2VsZWN0ZWQpO1xuICAgIH1cblxuICAgIHRoaXMuX2l0ZW1zID0gdGhpcy5nZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZCh0aGlzLml0ZW1zKTtcbiAgfVxufVxuIl19